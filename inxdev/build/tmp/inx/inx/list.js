// @include inx.panel

inx.css(".inx-list-item{vertical-align:top;overflow:hidden;padding:4px 10px 4px 10px;cursor:pointer;}",".inx-list-item-selected{background:#eaeaea;}",".inx-focused .inx-list-item-selected{background:#d9e8fb}");inx.list=inx.panel.extend({constructor:function(p){if(!p)p={};var that=this;p.private_selection=[];p.private_nodesToUpdate=[];p.heap={};if(!p.listeners)p.listeners={};if(p.onselect)p.listeners.select=p.onselect;if(p.onclick)p.listeners.click=p.onclick;this.private_itemsToUpdate=[];if(!p.emptyHTML)p.emptyHTML="...";this.base(p);if(p.renderer)this.renderer=p.renderer;},cmd_render:function(c){this.base(c);if(this.loader)this.cmd("load");this.cmd("setData",this.data);if(!this.enableTextSelection)
this.__body.addClass("inx-unselectable");},cmd_keydown:function(e){switch(e.keyCode){case 38:case 37:this.cmd("selectUp");return false;case 39:case 40:this.cmd("selectDown");return false;case 13:var sel=this.info("selection")[0];if(sel!==undefined){this.fire("click",sel,e);this.fire("dblclick",sel,e);}
return false;}},private_idFromEl:function(e){var hit=$(e).parents().andSelf().filter(".inx-list-item,.inx-list-item-odd").eq(0);return hit.data("id");},cmd_mousedown:function(e){var id=this.private_idFromEl(e.target);if(id!==undefined){this.cmd("select",id);this.fire("click",id,e);}},cmd_dblclick:function(e){var id=this.private_idFromEl(e.target);if(id)this.fire("dblclick",id,e);},cmd_setLoader:function(loader){this.loader=loader;},cmd_load:function(){if(!this.loader){inx.msg("error: loader in not defined",1);return;}
var ret=this.fire("beforeload",this.loader);if(ret===false)return;inx(this.privateLoadCommand).cmd("destroy");this.privateLoadCommand=this.call(this.loader,[this.id(),"handleLoadNative"]);},cmd_handleLoadNative:function(data,meta){this.fire("data",data,meta);this.cmd("setData",data);this.fire("load",data,meta);},renderer:function(e,data){if(data.separator){html="<hr>";}else{var html=data.text;if(data.icon)
html="<img src='"+inx.img(data.icon)+"' align='absmiddle' style='margin-right:8px;' />"+data.text;}
e.html(html);},cmd_clearSelection:function(){for(var id in this.private_selection)
this.private_updateItem(id);this.private_selection={};},cmd_select:function(id,add){this.cmd("clearSelection");this.private_selection[id]=true;this.fire("select",id);this.fire("selectionchange",[id]);this.private_updateItem(id);var el=this.heap[id];el&&inx.core.scrollTo(el.el);},info_selection:function(){var ret=[];for(var id in this.private_selection)
ret.push(id);return ret;},cmd_selectUp:function(){var sel=this.info("selection")[0];if(sel===undefined)return;var last=null;for(var i in this.data){if(this.data[i].id==sel)break;last=this.data[i].id;}
if(last!==null)this.cmd("select",last);},cmd_selectDown:function(){var sel=this.info("selection")[0];var found=!sel;for(var i in this.data){if(found){this.cmd("select",this.data[i].id);break;}
if(this.data[i].id==sel)found=1;}},private_updateItem:function(id){this.private_itemsToUpdate[id]=true;this.task("updateItems");},cmd_updateItems:function(){var cmpid=this.id();for(var id in this.private_itemsToUpdate){var item=this.heap[id];if(item){this.private_selection[id]?item.el.addClass("inx-list-item-selected"):item.el.removeClass("inx-list-item-selected");if(!item.clear){this.renderer(item.el,item.data);item.el.find("img").load(function(){inx(cmpid).task("resizeToContents");});}
item.clear=true;}else{delete this.private_selection[id];}}
this.private_itemsToUpdate=[];},info_item:function(id,key){var ret;for(var i in this.data)
if(this.data[i].id==id)
ret=this.data[i];if(ret&&key)ret=ret[key];return ret;},cmd_renderNodeTo:function(id,e){this.renderer(e,this.info("item",id));},cmd_set:function(id,set){for(var i=0;i<this.data.length;i++)
if(this.data[i].id==id){for(var key in set)
this.data[i][key]=set[key];this.renderer(this.heap[id].el,this.data[i]);}},info_data:function(){return this.data;},cmd_setData:function(data){if(!(data&&data.length))data=[];if(!this.__body){this.data=data;return;}
this.heap={};this.__body.html("");this.data=data;if(this.data.length){for(var i=0;i<data.length;i++)if(typeof(data[i])=="object"){if(data[i].id===undefined)data[i].id=inx.id();var e=$("<div />").appendTo(this.__body).data("id",data[i].id).addClass("inx-list-item");this.heap[data[i].id]={el:e,data:data[i]};this.private_updateItem(data[i].id);}}else{$("<div>").appendTo(this.__body).html(this.emptyHTML+"");}
this.cmd("updateItems");this.cmd("resizeToContents");}});