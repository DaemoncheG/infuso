// @include inx.dropdown,inx.calendar,inx.textfield,inx.layout.absolute

inx.date=inx.dropdown.extend({constructor:function(p){if(!p.width)p.width=95;p.dropdown={type:"inx.calendar",listeners:{click:[this.id(),"handleCalendar"]}};p.item={type:"inx.textfield",listeners:{focus:[this.id(),"handleFocus"]}}
p.side=[];if(p.time){p.width+=45;this.time=inx({type:"inx.date.time",region:"right",hideSeparator:true});p.side.push(this.time);p.side.push({type:"inx.box",width:2,region:"right",hideSeparator:true,background:"none"});}
p.side.push({type:"inx.toolbar_button",icon:"calendar",region:"right",onclick:[this.id(),"expand"],hideSeparator:true});p.side.push({type:"inx.box",width:2,region:"right",hideSeparator:true,background:"none"});this.on("expand",[this.id(),"handleExpand"]);this.base(p);this.suspendEvents();this.cmd("setValue",p.value);this.unsuspendEvents();if(p.onchange)this.on("change",p.onchange);},cmd_test:function(){inx.msg("this is as test");},cmd_handleFocus:function(){!this.a&&(this.a=setInterval(inx.cmd(this,"testChange"),500));},cmd_handleSmoothBlur:function(){this.a&&clearInterval(this.a);this.a=null;this.cmd("testChange");this.base();},cmd_testChange:function(){var val=this.info("value");if(val!=this.private_lastValue)
this.fire("change",val)
this.private_lastValue=val;},cmd_handleExpand:function(){this.dropdown().cmd("select",this.getValueAsObject());},strpad:function(str,count){str+="";var ret="";for(var i=0;i<count;i++)
ret+=(i>=count-str.length)?str.substr(str.length-count+i,1):"0";return ret;},canonizedToDate:function(val){if(val&&val.getTime)
var date;try{val=val.match(/(\d+)-(\d+)-(\d+)( (\d+):(\d+))?/);var year=val[1]*1;var month=val[2]*1;var day=val[3]*1;var hours=val[5]*1||0;var minutes=val[6]*1||0;var date=new Date(year,month-1,day,hours,minutes);}catch(ex){}
if(!date)var date=new Date();return date;},dateToLocal:function(date){return this.strpad(date.getDate(),2)+"."+this.strpad(date.getMonth()+1,2)+"."+this.strpad(date.getFullYear(),4);},cmd_setValue:function(val){var date=this.canonizedToDate(val);var local=this.dateToLocal(date);this.item().cmd("setValue",local);if(this.time){this.time.cmd("setHours",date.getHours());this.time.cmd("setMinutes",date.getMinutes());}
this.task("testChange");},info_value:function(){var val=this.item().info("value");try{var now=new Date();val=val.split(".");var day=val[0]||now.getDate();var month=val[1]||now.getMonth()+1;var year=val[2]||now.getFullYear()
var date=new Date(year,month-1,day);}catch(ex){var date=new Date();}
var ret=(this.strpad(date.getFullYear(),4)+"-"+
this.strpad(date.getMonth()+1,2)+"-"+
this.strpad(date.getDate(),2));if(this.time){ret+=" "+this.time.info("hours")+":"+this.time.info("minutes")+":00";}
return ret;},getValueAsObject:function(){var val=(this.info("value")+"").split("-");return{year:val[0],month:val[1],day:val[2]}},cmd_handleCalendar:function(a){this.cmd("setValue",a.year+"-"+a.month+"-"+a.day);this.cmd("collapse");}})
inx.date.time=inx.panel.extend({constructor:function(p){p.background="none";p.width=43;p.layout="inx.layout.absolute";this.hours=inx({type:"inx.textfield",width:20});this.minutes=inx({type:"inx.textfield",width:20,x:23});p.items=[this.hours,this.minutes];this.base(p);},cmd_setHours:function(h){var h=parseInt(h);if(!h)h=0;if(h<0)h=0;if(h>23)h=23;h=inx.strpad(h,2);this.hours.cmd("setValue",h);},cmd_setMinutes:function(h){var h=parseInt(h);if(!h)h=0;if(h<0)h=0;if(h>59)h=59;h=inx.strpad(h,2);this.minutes.cmd("setValue",h);},info_hours:function(h){var h=this.hours.info("value")*1;if(!h)h=0;if(h<0)h=0;if(h>23)h=23;return inx.strpad(h,2);},info_minutes:function(h){var h=this.minutes.info("value")*1;if(!h)h=0;if(h<0)h=0;if(h>59)h=59;return inx.strpad(h,2);}});