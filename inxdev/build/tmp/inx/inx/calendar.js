// @include inx.button

inx.css(".inx-calendar-right{background:url(%%inx.calendar%%/right.jpg) center;width:40px;height:270px;position:absolute;left:640px;cursor:pointer;}",".inx-calendar-left{background:url(%%inx.calendar%%/left.jpg) center;width:40px;height:270px;position:absolute;cursor:pointer;}",".inx-calendar-now{position:absolute;top:220px;left:300px;}");inx.calendar=inx.box.extend({constructor:function(p){if(!p)p={};p.width=680;p.height=270;p.__offset=0;var date=new Date();p.year=p.year*1||date.getFullYear();p.month=p.month*1||date.getMonth()+1;p.day=p.day*1||date.getDate();this.base(p);},cmd_render:function(c){this.base(c);var id=this.id();var left=$("<div />").addClass("inx-calendar-left").appendTo(this.el).click(function(){inx(id).cmd("doOffset",-1)});var right=$("<div />").addClass("inx-calendar-right").appendTo(this.el).click(function(){inx(id).cmd("doOffset",+1)});var now=$("<div />").addClass("inx-calendar-now").appendTo(this.el);var nowButton=inx({type:"inx.button",text:"Сегодня",onclick:[this.id(),"setNow"],width:100}).cmd("render",now).setOwner(this);this.mm=[];this.cmd("updateMonths");this.el.addClass("inx-unselectable");},cmd_updateMonths:function(){if(!this.el)return;for(var i=0;i<3;i++){if(!this.mm[i]){var e=$("<div >").appendTo(this.el).css({position:"absolute",left:i*200+40});var month=inx({type:"inx.calendar.month",border:0,listeners:{select:[this.id(),"handleClick"]},owner:this}).cmd("render",e);this.mm[i]=month;}
var p=this.offset(this.__offset+i-1);if(p.month!=this.month||p.year!=this.year)
p.day=0;this.mm[i].cmd("setData",p);}},cmd_doOffset:function(offset){this.__offset+=offset;this.cmd("updateMonths");},offset:function(offset){var m=this.year*12+this.month-1+offset;return{year:Math.floor(m/12),month:((m)%12)+1,day:this.day};},cmd_handleClick:function(p){this.fire("click",p);this.cmd("select",p);},cmd_select:function(p){var day=p.day*1;var month=p.month*1;var year=p.year*1;var date=new Date();if(!year)year=date.getFullYear();if(!month)month=date.getMonth()+1;if(!day)day=date.getDate();if(day==this.day&&month==this.month&&year==this.year)return;this.year=year;this.month=month;this.day=day;this.__offset=0;this.cmd("updateMonths");this.fire("select",p);},cmd_setNow:function(){this.cmd("handleClick",0);}})
inx.css(".inx-calendar-day{border:1px solid #ededed;cursor:pointer;background:#deded;padding:3px;width:13px;height:13px;position:absolute;text-align:center;font-size:11px;}",".inx-calendar-day-selected{border:1px solid gray}");inx.calendar.month=inx.box.extend({constructor:function(p){if(!p)p={};p.width=200;p.height=220;this.local={dayOfWeek:["вс","пн","вт","ср","чт","пт","сб"],month:[null,"Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],startWeekFrom:1}
this.base(p);},cmd_render:function(c){this.base(c);this.monthTitle=$("<div>").css({width:200,textAlign:"center",fontWeight:"bold",marginTop:20}).appendTo(this.el);this.days=[];for(var week=0;week<6;week++)
for(var wDay=0;wDay<7;wDay++)
this.days[wDay+week*7]=$("<div />").appendTo(this.el).addClass("inx-calendar-day").css({left:wDay*25+14,top:week*25+50}).mousedown(inx.cmd(this,"private_handleSelect"));},dayCount:function(y,m){var d=new Date(y,m-1,32);return 32-d.getDate();},redraw:function(){this.monthTitle.html(this.local.month[this.month]+" "+this.year)
var firstDay=new Date(this.year,this.month-1,1).getDay();var days=this.dayCount(this.year,this.month);var mDay=1;for(var week=0;week<=5;week++)
for(var wDay=0;wDay<7;wDay++)
if((week>0|wDay>=(firstDay+7-this.local.startWeekFrom)%7)&mDay<=days){this.days[week*7+wDay].html(mDay);this.days[week*7+wDay].css("display","block");if(mDay==this.day)
this.days[week*7+wDay].addClass("inx-calendar-day-selected");else
this.days[week*7+wDay].removeClass("inx-calendar-day-selected");mDay++;}else{if(week==0|week>=4)this.days[week*7+wDay].css("display","none");}},cmd_private_handleSelect:function(e){var day=$(e.target).html()*1;var data={year:this.year,month:this.month,day:day};this.fire("select",data);},cmd_setData:function(data){this.year=data.year;this.month=data.month;this.day=data.day;this.redraw();}})