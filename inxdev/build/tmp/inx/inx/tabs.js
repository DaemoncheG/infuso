// @include inx.panel

inx.tabs=inx.panel.extend({constructor:function(p){p.layout="inx.tabs.layout";if(!p.side)p.side=[];p.showHead=p.showHead===undefined?true:p.showHead;p.selectNew=p.selectNew===undefined?true:p.selectNew;if(p.showHead){this.tabs=inx.cmp.create({type:"inx.tabs.head",region:"top",height:p.headHeight});p.side.push(this.tabs);}
this.base(p);if(p.onselect)this.on("select",p.onselect);},cmd_hideTabs:function(){this.tabs.cmd("hide");},cmd_selectLast:function(){if(!this.items.length){this.cmd("select",false);return;}
var id=this.items[this.items.length-1];if(!inx(this.info("selected")).exists())
this.cmd("select",id);},cmd_select:function(id){id=inx(id).id();if(this.private_selected==id)return;this.private_selected=id;this.task("updateSelection");this.fire("select",id);this.task("resizeToContents");},cmd_updateSelection:function(){for(var i=0;i<this.items.length;i++){var cmp=inx(this.items[i]);if(cmp.id()==this.private_selected)cmp.cmd("show");else cmp.cmd("hide");}
if(this.tabs)this.tabs.cmd("update",this.items);},info_selected:function(){return this.private_selected},cmd_handleComponentLoaded:function(){if(this.tabs)this.tabs.cmd("update",this.items);},cmd_add:function(cmp){if(cmp.name){var same=this.find(cmp.name);if(same.exists()){this.cmd("select",same);return same;}}
if(cmp.lazy){var tabs=this;var c2=inx({type:"inx.panel",title:cmp.title,listeners:{show:function(){var c=inx(cmp,"inx.panel");tabs.cmd("add",c);c.data("priority",inx(this).data("priority"));tabs.cmd("select",c);this.cmd("destroy");}}});this.base(c2);return c2;}else{c=inx(cmp,"inx.panel");this.base(c);}}});inx.css(".inx-tabs{background:#9c9c9c url(%%inx.tabs%%/panel.gif) bottom repeat-x;}",".inx-tabs{font-size:11px;font-weight:bold;}",".inx-tabs-tab{border-left:1px solid #bfbfbf;border-right:1px solid #bfbfbf;cursor:pointer;vertical-align:bottom;padding:1px 3px 1px 3px;}",".inx-tabs-separator{cursor:pointer;width:1px;background:#636363}",".inx-tabs-selectedTab{border-left:1px solid white;border-right:1px solid white;background:url(%%inx.res%%/bg.gif) center center}",".inx-tabs-close{width:11px;height:11px;cursor:pointer;margin-left:4px;}")
inx.tabs.head=inx.box.extend({constructor:function(p){if(!p)p={};if(!p.height)p.height=17;p.border=0;this.base(p);},cmd_update:function(items){items=items.sort(function(a,b){return inx(a).data("priority")-inx(b).data("priority");});this.el.html("");for(var i=0;i<items.length;i++){var title=inx(items[i]).info("title");title=title?title+"":"";var e=$("<div />").addClass("inx-tabs-tab inx-core-inlineBlock").appendTo(this.el).html(title).css({height:this.info("height")-2}).data("id",items[i]);if(this.owner().info("selected")==items[i])e.addClass("inx-tabs-selectedTab");else e.css({opacity:0.5});var over=function(){this.src=inx.conf.url+"/inx/tabs/close_hover.gif";}
var out=function(){this.src=inx.conf.url+"/inx/tabs/close.gif";}
if(inx(items[i]).info("param","closable"))
var close=$("<img>").attr("src",inx.conf.url+"/inx/tabs/close.gif").addClass("inx-tabs-close").attr("align","absmiddle").appendTo(e).data("id",items[i]).mouseover(over).mouseout(out);var e=$("<div />").addClass("inx-core-inlineBlock inx-tabs-separator").css({height:this.info("height")}).appendTo(this.el).html("&nbsp;");}},cmd_syncLayout:function(){this.base();this.cmd("updateHeight");},cmd_render:function(c){this.base(c);this.el.addClass("inx-tabs").addClass("inx-unselectable");},cmd_mousedown:function(e){var id=$(e.target).parents().andSelf().filter(".inx-tabs-close").data("id");if(id){inx(id).cmd("destroy");return;}
var id=$(e.target).parents().andSelf().filter(".inx-tabs-tab").data("id");id&&this.owner().cmd("select",id);}});inx.tabs.layout={create:function(){this.__body.css("background","#ededed");},add:function(cmp){cmp=inx(cmp);cmp.cmd("border",0);cmp.cmd("render",this.__body);cmp.on("componentLoaded",[this.id(),"handleComponentLoaded"]);cmp.on("titleChanged",[this.id(),"handleComponentLoaded"]);cmp.cmd("hide");if(this.selectNew)
this.cmd("select",cmp.id());else{if(this.items[0]==cmp.id())
this.cmd("select",cmp.id());}
this.private_tabsPriority=(this.private_tabsPriority||0)+1;cmp.data("priority",this.private_tabsPriority);this.task("updateSelection");},remove:function(cmp){this.task("selectLast");this.task("updateSelection");},sync:function(){if(!this.private_autoHeight)
for(var i=0;i<this.items.length;i++)
if(!inx.cmp.get(this.items[i]).info("hidden"))
inx(this.items[i]).cmd("height",this.__bodyHeight);}}